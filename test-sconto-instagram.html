<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sconto Instagram - Elite Escape</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="catamaran-config.js"></script>
</head>
<body class="bg-gray-50 p-8">

<div class="max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Test Funzionalit√† Sconto Instagram</h1>
    
    <!-- Test Admin Controls -->
    <div class="bg-white p-6 rounded-lg border mb-6">
        <h2 class="text-lg font-semibold mb-4">Controlli Admin</h2>
        
        <div class="space-y-4">
            <label class="flex items-center">
                <input type="checkbox" id="instagram-discount-enabled" checked class="mr-2">
                <span>Abilita sconto Instagram</span>
            </label>
            
            <div>
                <label class="block mb-1">Etichetta Sconto:</label>
                <input type="text" id="admin-discount-label" value="Sconto Instagram -10%" 
                       class="w-full px-3 py-2 border rounded">
            </div>
            
            <div>
                <label class="block mb-1">Percentuale Sconto:</label>
                <input type="number" id="admin-discount-percentage" value="10" min="0" max="100" 
                       class="w-24 px-3 py-2 border rounded">
                <span class="ml-1">%</span>
            </div>
            
            <div>
                <label class="block mb-1">Prezzo Base:</label>
                <input type="number" id="admin-base-price" value="3499" 
                       class="w-32 px-3 py-2 border rounded">
                <span class="ml-1">‚Ç¨</span>
            </div>
            
            <button onclick="testSaveConfig()" 
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Salva Configurazione
            </button>
        </div>
    </div>
    
    <!-- Test Booking Display -->
    <div class="bg-white p-6 rounded-lg border">
        <h2 class="text-lg font-semibold mb-4">Anteprima Pagina Prenotazione</h2>
        
        <div class="space-y-2">
            <div class="flex justify-between">
                <span class="text-gray-600">Prezzo base per questa settimana (7 giorni)</span>
                <span class="font-medium" id="test-base-price">‚Ç¨ 3.499</span>
            </div>
            
            <div id="test-discount-section" class="flex justify-between text-green-600">
                <span id="test-discount-label">Sconto Instagram -10%</span>
                <span id="test-discount-amount">-‚Ç¨ 349,90</span>
            </div>
            
            <hr class="my-4">
            
            <div class="flex justify-between font-bold">
                <span>Totale (solo per test):</span>
                <span id="test-total">‚Ç¨ 3.149,10</span>
            </div>
        </div>
        
        <button onclick="testUpdateDisplay()" 
                class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            Aggiorna Anteprima
        </button>
    </div>
    
    <!-- Test Results -->
    <div class="bg-gray-100 p-4 rounded-lg mt-6">
        <h3 class="font-semibold mb-2">Log Test:</h3>
        <pre id="test-log" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
    </div>
</div>

<script>
function log(message) {
    const logElement = document.getElementById('test-log');
    const timestamp = new Date().toLocaleTimeString();
    logElement.textContent += `[${timestamp}] ${message}\n`;
}

function testSaveConfig() {
    try {
        const config = CatamaranStorage.load();
        
        const discountEnabled = document.getElementById('instagram-discount-enabled');
        const discountLabel = document.getElementById('admin-discount-label');
        const discountPercentage = document.getElementById('admin-discount-percentage');
        const basePrice = document.getElementById('admin-base-price');
        
        // Assicurati che la struttura pricing esista
        if (!config.pricing) {
            config.pricing = {};
        }
        if (!config.pricing.instagramDiscount) {
            config.pricing.instagramDiscount = {};
        }
        
        // Aggiorna configurazione
        config.pricing.instagramDiscount.enabled = discountEnabled.checked;
        config.pricing.instagramDiscount.label = discountLabel.value;
        config.pricing.instagramDiscount.percentage = parseFloat(discountPercentage.value);
        config.basic.basePrice = parseFloat(basePrice.value);
        
        // Calcola importo sconto
        const percentage = parseFloat(discountPercentage.value);
        const basePriceValue = parseFloat(basePrice.value);
        config.pricing.instagramDiscount.amount = (basePriceValue * percentage) / 100;
        
        // Salva
        const saved = CatamaranStorage.save(config);
        
        if (saved) {
            log('‚úì Configurazione salvata con successo!');
            log(`- Abilitato: ${config.pricing.instagramDiscount.enabled}`);
            log(`- Etichetta: "${config.pricing.instagramDiscount.label}"`);
            log(`- Percentuale: ${config.pricing.instagramDiscount.percentage}%`);
            log(`- Importo: ‚Ç¨${config.pricing.instagramDiscount.amount.toFixed(2)}`);
        } else {
            log('‚úó Errore nel salvataggio');
        }
        
    } catch (error) {
        log('‚úó Errore: ' + error.message);
    }
}

function testUpdateDisplay() {
    try {
        const config = CatamaranStorage.load();
        const discountConfig = config.pricing && config.pricing.instagramDiscount ? config.pricing.instagramDiscount : {
            enabled: true,
            percentage: 10,
            label: "Sconto Instagram -10%"
        };
        
        const basePrice = config.basic.basePrice || 3499;
        const discountAmount = discountConfig.enabled ? (basePrice * (discountConfig.percentage / 100)) : 0;
        
        // Aggiorna display
        const basePriceElement = document.getElementById('test-base-price');
        const discountSection = document.getElementById('test-discount-section');
        const discountLabel = document.getElementById('test-discount-label');
        const discountAmountElement = document.getElementById('test-discount-amount');
        const totalElement = document.getElementById('test-total');
        
        basePriceElement.textContent = `‚Ç¨ ${basePrice.toLocaleString()}`;
        
        if (discountConfig.enabled && discountAmount > 0) {
            discountSection.style.display = 'flex';
            discountLabel.textContent = discountConfig.label;
            discountAmountElement.textContent = `-‚Ç¨ ${discountAmount.toFixed(2).replace('.', ',')}`;
            
            const total = basePrice - discountAmount;
            totalElement.textContent = `‚Ç¨ ${total.toFixed(2).replace('.', ',')}`;
        } else {
            discountSection.style.display = 'none';
            totalElement.textContent = `‚Ç¨ ${basePrice.toFixed(2).replace('.', ',')}`;
        }
        
        log('‚úì Display aggiornato con successo!');
        log(`- Prezzo base: ‚Ç¨${basePrice}`);
        log(`- Sconto abilitato: ${discountConfig.enabled}`);
        log(`- Importo sconto: ‚Ç¨${discountAmount.toFixed(2)}`);
        log(`- Totale: ‚Ç¨${(basePrice - discountAmount).toFixed(2)}`);
        
    } catch (error) {
        log('‚úó Errore aggiornamento display: ' + error.message);
    }
}

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
    log('üöÄ Test inizializzato');
    
    // Collega eventi per aggiornamento automatico
    const controls = ['instagram-discount-enabled', 'admin-discount-label', 'admin-discount-percentage', 'admin-base-price'];
    controls.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', testUpdateDisplay);
            element.addEventListener('input', testUpdateDisplay);
        }
    });
    
    // Carica configurazione iniziale
    testUpdateDisplay();
});
</script>

</body>
</html>