<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Configurazione Catamarano</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>tailwind.config={theme:{extend:{colors:{primary:'#0a5c8f',secondary:'#f8b400'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Raleway:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
<script src="catamaran-config.js"></script>
<style>
:where([class^="ri-"])::before { content: "\f3c2"; }
body {
font-family: 'Raleway', sans-serif;
background-color: #f9fafb;
}
h1, h2, h3, h4, h5, h6 {
font-family: 'Playfair Display', serif;
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
-webkit-appearance: none;
margin: 0;
}
</style>
</head>
<body class="bg-gray-50">

<!-- Header -->
<header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center h-16">
<div class="flex items-center space-x-4">
<div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
<i class="ri-ship-line text-white"></i>
</div>
<h1 class="text-xl font-semibold text-gray-900">Admin Panel</h1>
</div>
<div class="flex items-center space-x-2">
<button id="save-button" class="bg-primary text-white px-4 py-2 rounded-lg flex items-center whitespace-nowrap">
<i class="ri-save-line mr-2"></i>
<span class="hidden md:inline">Salva Modifiche</span>
<span class="md:hidden">Salva</span>
</button>
</div>
</div>
</div>
</header>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

<!-- Informazioni Base -->
<div class="lg:col-span-2">
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
<div class="px-6 py-4 border-b border-gray-200">
<h2 class="text-lg font-semibold text-gray-900">Informazioni Base</h2>
</div>
<div class="p-6 space-y-6">

<!-- Nome Catamarano -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Nome Catamarano</label>
<input type="text" id="admin-catamaran-name" value="Bali Catsmart - Violante" 
class="w-full px-4 py-2 border border-gray-300 rounded focus:border-primary focus:ring-1 focus:ring-primary">
</div>

<!-- Configurazione Badge Prezzo di Partenza -->
<div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
<h4 class="font-medium text-gray-900 mb-4">Badge Prezzo di Partenza</h4>

<!-- Prezzo di Partenza -->
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">Prezzo di Partenza</label>
<div class="flex items-center">
<span class="bg-gray-100 px-4 py-2 border border-r-0 border-gray-300 rounded-l text-gray-600">€</span>
<input type="number" id="admin-starting-price" value="2999" 
class="w-40 px-4 py-2 border border-gray-300 rounded-r focus:border-primary focus:ring-1 focus:ring-primary">
</div>
<p class="mt-1 text-xs text-gray-500">Prezzo mostrato nel badge (solo marketing)</p>
</div>

<!-- Testo del Badge -->
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">Testo del Badge</label>
<input type="text" id="admin-badge-text" value="A partire da" 
placeholder="es. A partire da, Da solo, Offerta da..."
class="w-full px-4 py-2 border border-gray-300 rounded focus:border-primary focus:ring-1 focus:ring-primary">
<p class="mt-1 text-xs text-gray-500">Testo che appare sopra il prezzo nel badge</p>
</div>

<!-- Colore del Badge -->
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">Colore del Badge</label>
<div class="flex items-center space-x-3">
<input type="color" id="admin-badge-color" value="#f8b400" 
class="w-12 h-10 border border-gray-300 rounded cursor-pointer">
<input type="text" id="admin-badge-color-text" value="#f8b400" 
placeholder="#f8b400"
class="flex-1 px-4 py-2 border border-gray-300 rounded focus:border-primary focus:ring-1 focus:ring-primary">
</div>
<p class="mt-1 text-xs text-gray-500">Colore di sfondo del badge (in formato esadecimale)</p>
</div>

<!-- Anteprima Badge -->
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">Anteprima</label>
<div class="flex justify-center p-4 bg-gray-200 rounded-lg">
<div id="badge-preview" class="px-4 py-2 rounded-full text-sm font-semibold shadow-lg flex flex-col items-center min-w-[120px]" style="background-color: #f8b400; color: #ffffff;">
<span class="text-xs mb-1">A partire da</span>
<span class="text-lg font-bold">€2.999</span>
</div>
</div>
</div>

</div>

<!-- Prezzo Base -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Prezzo Base per Questa Settimana</label>
<div class="flex items-center">
<span class="bg-gray-100 px-4 py-2 border border-r-0 border-gray-300 rounded-l text-gray-600">€</span>
<input type="number" id="admin-base-price" value="3499" 
class="w-40 px-4 py-2 border border-gray-300 rounded-r focus:border-primary focus:ring-1 focus:ring-primary">
</div>
<p class="mt-1 text-xs text-gray-500">Prezzo utilizzato per i calcoli in base alle date selezionate</p>
</div>

<!-- Anno -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Anno</label>
<input type="number" id="admin-year" value="2025" 
class="w-full px-4 py-2 border border-gray-300 rounded focus:border-primary focus:ring-1 focus:ring-primary">
</div>

<!-- Titolo Principale -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Titolo Principale Pagina</label>
<input type="text" id="admin-main-heading" value="Prenota il tuo Catamarano" 
placeholder="Titolo che appare in cima alla pagina di prenotazione"
class="w-full px-4 py-2 border border-gray-300 rounded focus:border-primary focus:ring-1 focus:ring-primary">
<p class="mt-1 text-xs text-gray-500">Questo testo apparirà come titolo principale della pagina di prenotazione</p>
</div>

</div>
</div>
</div>

<!-- Logo Configuration -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Logo Aziendale</h2>
    </div>
    <div class="p-6 space-y-6">
        
        <!-- Logo Upload -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Logo</label>
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <input type="file" id="admin-logo-upload" accept="image/*" 
                           class="hidden">
                    <label for="admin-logo-upload" 
                           class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 rounded bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        <i class="ri-image-line mr-2"></i>
                        Carica Logo
                    </label>
                    <p class="mt-1 text-xs text-gray-500">PNG, JPG fino a 2MB. Dimensioni consigliate: 200x60px</p>
                </div>
                <div class="flex-shrink-0">
                    <div id="logo-preview" class="w-32 h-16 border-2 border-dashed border-gray-300 rounded flex items-center justify-center bg-gray-50">
                        <span class="text-sm text-gray-500">Anteprima</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logo Alternative Text -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Testo Alternativo</label>
            <input type="text" id="admin-logo-text" value="logo" 
                   placeholder="Testo da mostrare se il logo non è disponibile"
                   class="w-full px-4 py-2 border border-gray-300 rounded focus:border-primary focus:ring-1 focus:ring-primary">
            <p class="mt-1 text-xs text-gray-500">Questo testo apparirà se non viene caricato alcun logo</p>
        </div>

        <!-- Reset Logo -->
        <div>
            <button id="reset-logo-button" 
                    class="inline-flex items-center px-4 py-2 border border-red-300 rounded text-sm font-medium text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                <i class="ri-delete-bin-line mr-2"></i>
                Rimuovi Logo
            </button>
        </div>

    </div>
</div>

<!-- Prezzi Pacchetti -->
<div>
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
<div class="px-6 py-4 border-b border-gray-200">
<h2 class="text-lg font-semibold text-gray-900">Prezzi Pacchetti</h2>
</div>
<div class="p-6 space-y-6">

<!-- Charter -->
<div>
<h4 class="font-medium text-gray-900">Pacchetto Charter</h4>
<div class="flex items-center mt-1">
<span class="text-sm text-gray-600 mr-2">Prezzo:</span>
<div class="flex items-center">
<span class="bg-gray-100 px-2 py-1 border border-r-0 border-gray-300 rounded-l text-sm">€</span>
<input type="number" id="admin-charter-price" value="400" 
class="w-24 px-2 py-1 border border-gray-300 rounded-r text-sm focus:border-primary focus:ring-1 focus:ring-primary">
</div>
</div>
</div>

<!-- Carburante -->
<div>
<h4 class="font-medium text-gray-900">Carburante No Stress</h4>
<div class="flex items-center mt-1">
<span class="text-sm text-gray-600 mr-2">Prezzo:</span>
<div class="flex items-center">
<span class="bg-gray-100 px-2 py-1 border border-r-0 border-gray-300 rounded-l text-sm">€</span>
<input type="number" id="admin-fuel-price" value="350" 
class="w-24 px-2 py-1 border border-gray-300 rounded-r text-sm focus:border-primary focus:ring-1 focus:ring-primary">
</div>
</div>
</div>

<!-- Lenzuola -->
<div>
<h4 class="font-medium text-gray-900">Lenzuola e salviette</h4>
<div class="flex items-center mt-1">
<span class="text-sm text-gray-600 mr-2">Prezzo per ospite:</span>
<div class="flex items-center">
<span class="bg-gray-100 px-2 py-1 border border-r-0 border-gray-300 rounded-l text-sm">€</span>
<input type="number" id="admin-linens-price" value="20" 
class="w-24 px-2 py-1 border border-gray-300 rounded-r text-sm focus:border-primary focus:ring-1 focus:ring-primary">
</div>
</div>
</div>

<!-- Skipper -->
<div>
<h4 class="font-medium text-gray-900">Skipper Professionale</h4>
<div class="flex items-center mt-1">
<span class="text-sm text-gray-600 mr-2">Prezzo al giorno:</span>
<div class="flex items-center">
<span class="bg-gray-100 px-2 py-1 border border-r-0 border-gray-300 rounded-l text-sm">€</span>
<input type="number" id="admin-skipper-price" value="200" 
class="w-24 px-2 py-1 border border-gray-300 rounded-r text-sm focus:border-primary focus:ring-1 focus:ring-primary">
</div>
</div>
</div>

</div>
</div>
</div>

</div>

<!-- Calendario Prezzi Settimanali -->
<div class="mt-8">
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
<div class="px-6 py-4 border-b border-gray-200">
<div class="flex justify-between items-center">
<h2 class="text-lg font-semibold text-gray-900">Calendario Prezzi Settimanali</h2>
<div class="flex items-center space-x-2">
<label class="flex items-center">
<input type="checkbox" id="weekly-pricing-enabled" checked class="mr-2">
<span class="text-sm text-gray-600">Abilita prezzi dinamici</span>
</label>
</div>
</div>
</div>
<div class="p-6">

<!-- Controlli Navigazione -->
<div class="flex justify-between items-center mb-6">
<div class="flex items-center space-x-4">
<select id="calendar-year" class="px-3 py-2 border border-gray-300 rounded focus:border-primary">
<option value="2025">2025</option>
<option value="2026">2026</option>
</select>
<div class="flex items-center space-x-2">
<button id="prev-month" class="p-2 hover:bg-gray-100 rounded-full">
<i class="ri-arrow-left-s-line"></i>
</button>
<span id="current-month-display" class="text-lg font-medium min-w-[120px] text-center">Maggio 2025</span>
<button id="next-month" class="p-2 hover:bg-gray-100 rounded-full">
<i class="ri-arrow-right-s-line"></i>
</button>
</div>
</div>
<div class="flex items-center space-x-2">
<span class="text-sm text-gray-600">Prezzo default:</span>
<div class="flex items-center">
<span class="bg-gray-100 px-2 py-1 border border-r-0 border-gray-300 rounded-l text-sm">€</span>
<input type="number" id="default-weekly-price" value="3999" 
class="w-20 px-2 py-1 border border-gray-300 rounded-r text-sm focus:border-primary">
</div>
</div>
</div>

<!-- Template Stagionali -->
<div class="mb-6 p-4 bg-gray-50 rounded-lg">
<h4 class="font-medium text-gray-900 mb-3">Template Stagionali</h4>
<div class="flex flex-wrap gap-2">
<button class="template-btn px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200" data-price="2999">
Bassa Stagione (€2.999)
</button>
<button class="template-btn px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm hover:bg-green-200" data-price="3999">
Media Stagione (€3.999)
</button>
<button class="template-btn px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm hover:bg-red-200" data-price="4999">
Alta Stagione (€4.999)
</button>
</div>
</div>

<!-- Calendario -->
<div class="border border-gray-200 rounded-lg overflow-hidden">
<div class="grid grid-cols-8 text-center border-b border-gray-200 bg-gray-50">
<div class="py-3 text-xs font-medium text-gray-500">Settimana</div>
<div class="py-3 text-xs font-medium text-gray-500">Dom</div>
<div class="py-3 text-xs font-medium text-gray-500">Lun</div>
<div class="py-3 text-xs font-medium text-gray-500">Mar</div>
<div class="py-3 text-xs font-medium text-gray-500">Mer</div>
<div class="py-3 text-xs font-medium text-gray-500">Gio</div>
<div class="py-3 text-xs font-medium text-gray-500">Ven</div>
<div class="py-3 text-xs font-medium text-gray-500">Sab</div>
</div>
<div id="pricing-calendar" class="divide-y divide-gray-200">
<!-- Le righe del calendario verranno generate dinamicamente -->
</div>
</div>

<!-- Editor Prezzo Settimana -->
<div id="week-price-editor" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
<div class="flex justify-between items-start">
<div>
<h4 class="font-medium text-gray-900 mb-2">Modifica Prezzo Settimana</h4>
<p class="text-sm text-gray-600" id="selected-week-info">Settimana selezionata</p>
</div>
<button id="close-editor" class="text-gray-400 hover:text-gray-600">
<i class="ri-close-line"></i>
</button>
</div>
<div class="mt-4 flex items-center space-x-4">
<div class="flex items-center">
<span class="bg-gray-100 px-3 py-2 border border-r-0 border-gray-300 rounded-l text-sm">€</span>
<input type="number" id="week-price-input" value="3999" 
class="w-24 px-3 py-2 border border-gray-300 text-sm focus:border-primary">
</div>
<input type="text" id="week-note-input" placeholder="Note (opzionale)" 
class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-primary">
<button id="save-week-price" class="bg-primary text-white px-4 py-2 rounded text-sm hover:bg-opacity-90">
Salva
</button>
</div>
</div>

</div>
</div>
</div>

<!-- Bottom Save Button -->
<div class="mt-8 flex justify-center">
<button id="save-button-bottom" class="bg-primary text-white px-6 py-3 rounded-lg flex items-center">
<i class="ri-save-line mr-2"></i>
Salva Modifiche
</button>
</div>

</main>

<script>
// Funzioni globali per gestire la configurazione
window.saveConfiguration = function() {
    try {
        console.log('=== INIZIO SALVATAGGIO ===');
        const config = CatamaranStorage.load();
        
        // Aggiorna informazioni base
        const nameInput = document.getElementById('admin-catamaran-name');
        const startingPriceInput = document.getElementById('admin-starting-price');
        const priceInput = document.getElementById('admin-base-price');
        const yearInput = document.getElementById('admin-year');
        const mainHeadingInput = document.getElementById('admin-main-heading');
        
        console.log('Campi trovati:');
        console.log('- Nome:', nameInput ? nameInput.value : 'NON TROVATO');
        console.log('- Prezzo Partenza:', startingPriceInput ? startingPriceInput.value : 'NON TROVATO');
        console.log('- Prezzo Base:', priceInput ? priceInput.value : 'NON TROVATO');
        console.log('- Anno:', yearInput ? yearInput.value : 'NON TROVATO');
        console.log('- Titolo:', mainHeadingInput ? mainHeadingInput.value : 'NON TROVATO');
        
        if (nameInput && nameInput.value) {
            console.log('Aggiornando nome da:', config.basic.name, 'a:', nameInput.value);
            config.basic.name = nameInput.value;
        }
        if (startingPriceInput && startingPriceInput.value) {
            console.log('Aggiornando prezzo partenza da:', config.basic.startingPrice, 'a:', startingPriceInput.value);
            config.basic.startingPrice = parseInt(startingPriceInput.value);
        }
        
        // Assicurati che la struttura badge esista prima del salvataggio
        if (!config.priceBadge) {
            config.priceBadge = {
                enabled: true,
                text: "A partire da",
                color: "#f8b400",
                textColor: "#ffffff"
            };
        }
        
        // Aggiorna badge configuration
        const badgeTextInput = document.getElementById('admin-badge-text');
        const badgeColorInput = document.getElementById('admin-badge-color-text');
        
        if (badgeTextInput && badgeTextInput.value) {
            console.log('Aggiornando testo badge da:', config.priceBadge.text, 'a:', badgeTextInput.value);
            config.priceBadge.text = badgeTextInput.value;
        }
        if (badgeColorInput && badgeColorInput.value) {
            console.log('Aggiornando colore badge da:', config.priceBadge.color, 'a:', badgeColorInput.value);
            config.priceBadge.color = badgeColorInput.value;
        }
        if (priceInput && priceInput.value) {
            console.log('Aggiornando prezzo base da:', config.basic.basePrice, 'a:', priceInput.value);
            config.basic.basePrice = parseInt(priceInput.value);
        }
        if (yearInput && yearInput.value) {
            console.log('Aggiornando anno da:', config.basic.year, 'a:', yearInput.value);
            config.basic.year = parseInt(yearInput.value);
        }
        if (mainHeadingInput && mainHeadingInput.value) {
            console.log('Aggiornando titolo da:', config.ui.mainHeading, 'a:', mainHeadingInput.value);
            config.ui.mainHeading = mainHeadingInput.value;
        }
        
        // Aggiorna prezzi pacchetti
        const charterPriceInput = document.getElementById('admin-charter-price');
        const fuelPriceInput = document.getElementById('admin-fuel-price');
        const linensPriceInput = document.getElementById('admin-linens-price');
        const skipperPriceInput = document.getElementById('admin-skipper-price');
        
        if (charterPriceInput && charterPriceInput.value) {
            config.mandatoryPackages.charter.price = parseInt(charterPriceInput.value);
            console.log('Charter aggiornato:', charterPriceInput.value);
        }
        if (fuelPriceInput && fuelPriceInput.value) {
            config.mandatoryPackages.fuel.price = parseInt(fuelPriceInput.value);
            console.log('Fuel aggiornato:', fuelPriceInput.value);
        }
        if (linensPriceInput && linensPriceInput.value) {
            config.mandatoryPackages.linens.pricePerGuest = parseInt(linensPriceInput.value);
            console.log('Lenzuola aggiornate:', linensPriceInput.value);
        }
        if (skipperPriceInput && skipperPriceInput.value) {
            config.additionalServices.skipper.price = parseInt(skipperPriceInput.value);
            console.log('Skipper aggiornato:', skipperPriceInput.value);
        }
        
        // Aggiorna logo
        const logoTextInput = document.getElementById('admin-logo-text');
        if (logoTextInput && logoTextInput.value) {
            config.theme.logo.text = logoTextInput.value;
            console.log('Logo text aggiornato:', logoTextInput.value);
        }
        
        // Aggiorna impostazioni calendario prezzi settimanali
        const weeklyPricingEnabled = document.getElementById('weekly-pricing-enabled');
        const defaultWeeklyPriceInput = document.getElementById('default-weekly-price');
        
        // Assicurati che la struttura weeklyPricing esista
        if (!config.weeklyPricing) {
            config.weeklyPricing = {
                enabled: true,
                defaultPrice: 3999,
                weeks: {},
                templates: {
                    "alta_stagione": 4999,
                    "media_stagione": 3999,
                    "bassa_stagione": 2999
                }
            };
        }
        
        if (weeklyPricingEnabled) {
            config.weeklyPricing.enabled = weeklyPricingEnabled.checked;
            console.log('Prezzi settimanali abilitati:', weeklyPricingEnabled.checked);
        }
        
        if (defaultWeeklyPriceInput && defaultWeeklyPriceInput.value) {
            config.weeklyPricing.defaultPrice = parseInt(defaultWeeklyPriceInput.value);
            console.log('Prezzo default settimanale aggiornato:', defaultWeeklyPriceInput.value);
        }
        
        // Salva la configurazione
        const saved = CatamaranStorage.save(config);
        
        if (saved) {
            console.log('✓ Configurazione salvata con successo!');
            showNotification('✓ Configurazione salvata con successo!', 'success');
        } else {
            console.log('✗ Errore nel salvataggio');
            showNotification('✗ Errore nel salvataggio della configurazione', 'error');
        }
        
    } catch (error) {
        console.error('Errore saveConfiguration:', error);
        showNotification('✗ Errore: ' + error.message, 'error');
    }
};

window.loadConfiguration = function() {
    try {
        const config = CatamaranStorage.load();
        
        // Migrazione della configurazione logo (da stringa a oggetto)
        if (typeof config.theme.logo === 'string') {
            console.log('🔄 Migrazione configurazione logo da stringa a oggetto');
            const oldLogoText = config.theme.logo;
            config.theme.logo = {
                type: 'text',
                imageUrl: '',
                text: oldLogoText
            };
            // Salva la configurazione migrata
            CatamaranStorage.save(config);
        }
        
        // Assicurati che la struttura logo esista
        if (!config.theme.logo) {
            config.theme.logo = { type: 'text', imageUrl: '', text: 'logo' };
        }
        
        // Carica informazioni base
        const nameInput = document.getElementById('admin-catamaran-name');
        const startingPriceInput = document.getElementById('admin-starting-price');
        const priceInput = document.getElementById('admin-base-price');
        const yearInput = document.getElementById('admin-year');
        const mainHeadingInput = document.getElementById('admin-main-heading');
        
        if (nameInput) nameInput.value = config.basic.name;
        if (startingPriceInput) startingPriceInput.value = config.basic.startingPrice || 2999;
        if (priceInput) priceInput.value = config.basic.basePrice;
        if (yearInput) yearInput.value = config.basic.year;
        if (mainHeadingInput) mainHeadingInput.value = config.ui.mainHeading;
        
        // Carica configurazione badge
        const badgeTextInput = document.getElementById('admin-badge-text');
        const badgeColorInput = document.getElementById('admin-badge-color');
        const badgeColorTextInput = document.getElementById('admin-badge-color-text');
        
        // Assicurati che la struttura badge esista
        if (!config.priceBadge) {
            config.priceBadge = {
                enabled: true,
                text: "A partire da",
                color: "#f8b400",
                textColor: "#ffffff"
            };
        }
        
        if (badgeTextInput) badgeTextInput.value = config.priceBadge.text;
        if (badgeColorInput) badgeColorInput.value = config.priceBadge.color;
        if (badgeColorTextInput) badgeColorTextInput.value = config.priceBadge.color;
        
        // Carica prezzi pacchetti
        const charterPriceInput = document.getElementById('admin-charter-price');
        const fuelPriceInput = document.getElementById('admin-fuel-price');
        const linensPriceInput = document.getElementById('admin-linens-price');
        const skipperPriceInput = document.getElementById('admin-skipper-price');
        
        if (charterPriceInput) charterPriceInput.value = config.mandatoryPackages.charter.price;
        if (fuelPriceInput) fuelPriceInput.value = config.mandatoryPackages.fuel.price;
        if (linensPriceInput) linensPriceInput.value = config.mandatoryPackages.linens.pricePerGuest;
        if (skipperPriceInput) skipperPriceInput.value = config.additionalServices.skipper.price;
        
        // Carica logo
        const logoTextInput = document.getElementById('admin-logo-text');
        if (logoTextInput) logoTextInput.value = config.theme.logo.text;
        
        console.log('📂 Configurazione logo caricata:', config.theme.logo);
        
        // Aggiorna anteprima logo
        updateLogoPreview(config.theme.logo);
        
        // Carica impostazioni calendario prezzi settimanali
        const weeklyPricingEnabled = document.getElementById('weekly-pricing-enabled');
        const defaultWeeklyPriceInput = document.getElementById('default-weekly-price');
        
        // Assicurati che la struttura weeklyPricing esista
        if (!config.weeklyPricing) {
            config.weeklyPricing = {
                enabled: true,
                defaultPrice: 3999,
                weeks: {},
                templates: {
                    "alta_stagione": 4999,
                    "media_stagione": 3999,
                    "bassa_stagione": 2999
                }
            };
        }
        
        if (weeklyPricingEnabled) {
            weeklyPricingEnabled.checked = config.weeklyPricing.enabled !== false;
        }
        
        if (defaultWeeklyPriceInput) {
            defaultWeeklyPriceInput.value = config.weeklyPricing.defaultPrice || 3999;
        }
        
        console.log('📅 Configurazione calendario prezzi caricata');
        console.log('✓ Configurazione caricata');
        
    } catch (error) {
        console.error('Errore loadConfiguration:', error);
        showNotification('✗ Errore nel caricamento: ' + error.message, 'error');
    }
};

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
        type === 'error' ? 'bg-red-500' : 'bg-green-500'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Funzioni per gestire il badge
function updateBadgePreview() {
    const badgePreview = document.getElementById('badge-preview');
    const badgeTextInput = document.getElementById('admin-badge-text');
    const startingPriceInput = document.getElementById('admin-starting-price');
    const badgeColorTextInput = document.getElementById('admin-badge-color-text');
    
    if (badgePreview && badgeTextInput && startingPriceInput && badgeColorTextInput) {
        const text = badgeTextInput.value || 'A partire da';
        const price = startingPriceInput.value || '2999';
        const color = badgeColorTextInput.value || '#f8b400';
        
        badgePreview.style.backgroundColor = color;
        badgePreview.innerHTML = `
            <span class="text-xs mb-1">${text}</span>
            <span class="text-lg font-bold">€${parseInt(price).toLocaleString()}</span>
        `;
    }
}

function syncColorInputs() {
    const colorPicker = document.getElementById('admin-badge-color');
    const colorText = document.getElementById('admin-badge-color-text');
    
    if (colorPicker && colorText) {
        colorPicker.addEventListener('input', function() {
            colorText.value = this.value;
            updateBadgePreview();
        });
        
        colorText.addEventListener('input', function() {
            if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                colorPicker.value = this.value;
                updateBadgePreview();
            }
        });
    }
}

// === GESTIONE CALENDARIO PREZZI SETTIMANALI ===
let currentCalendarMonth = new Date().getMonth() + 1; // Gennaio = 1
let currentCalendarYear = new Date().getFullYear();
let selectedWeek = null;

// Genera il calendario dei prezzi per il mese corrente
function generatePricingCalendar(month, year) {
    console.log(`🗓️ Generando calendario per ${month}/${year}`);
    const calendar = document.getElementById('pricing-calendar');
    if (!calendar) {
        console.error('❌ Elemento pricing-calendar non trovato');
        return;
    }
    
    const config = CatamaranStorage.load();
    
    // Assicurati che la struttura weeklyPricing esista
    if (!config.weeklyPricing) {
        config.weeklyPricing = {
            enabled: true,
            defaultPrice: 3999,
            weeks: {},
            templates: {
                "alta_stagione": 4999,
                "media_stagione": 3999,
                "bassa_stagione": 2999
            }
        };
    }
    
    const monthNames = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                       'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    
    // Aggiorna display mese corrente
    const monthDisplay = document.getElementById('current-month-display');
    if (monthDisplay) {
        monthDisplay.textContent = `${monthNames[month]} ${year}`;
    }
    
    // Calcola le settimane del mese
    const weeks = getWeeksInMonth(month, year);
    
    // Pulisci calendario esistente
    calendar.innerHTML = '';
    
    // Genera le righe per ogni settimana
    weeks.forEach((week, weekIndex) => {
        const weekKey = `${year}-W${week.weekNumber.toString().padStart(2, '0')}`;
        const weekData = config.weeklyPricing.weeks[weekKey] || {
            price: config.weeklyPricing.defaultPrice,
            note: ''
        };
        
        
        const row = document.createElement('div');
        row.className = 'grid grid-cols-8 border-b border-gray-100 hover:bg-gray-50 cursor-pointer week-row';
        row.dataset.weekKey = weekKey;
        row.dataset.weekNumber = week.weekNumber;
        
        // Colonna settimana (numero + prezzo)
        const weekCell = document.createElement('div');
        weekCell.className = 'p-3 text-center border-r border-gray-100';
        weekCell.innerHTML = `
            <div class="text-sm font-medium text-gray-900">W${week.weekNumber}</div>
            <div class="text-xs text-primary font-bold">€${weekData.price.toLocaleString()}</div>
            ${weekData.note ? `<div class="text-xs text-gray-500 mt-1">${weekData.note}</div>` : ''}
        `;
        row.appendChild(weekCell);
        
        // Colonne giorni della settimana
        week.days.forEach(day => {
            const dayCell = document.createElement('div');
            dayCell.className = 'p-3 text-center text-sm';
            
            if (day.date) {
                const isCurrentMonth = day.date.getMonth() + 1 === month;
                dayCell.className += isCurrentMonth ? ' text-gray-900' : ' text-gray-400';
                dayCell.textContent = day.date.getDate();
            }
            
            row.appendChild(dayCell);
        });
        
        // Aggiungi evento click per modifica
        row.addEventListener('click', () => openWeekEditor(weekKey, week.weekNumber, weekData));
        
        calendar.appendChild(row);
    });
    
    console.log(`✅ Calendario generato con ${weeks.length} settimane`);
}

// Calcola le settimane di un mese
function getWeeksInMonth(month, year) {
    const weeks = [];
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    
    console.log(`📅 Generando settimane per ${month}/${year}: dal ${firstDay.toISOString().slice(0,10)} al ${lastDay.toISOString().slice(0,10)}`);
    
    // Trova il lunedì della settimana che contiene il primo giorno del mese
    let startDate = new Date(firstDay);
    const dayOfWeek = startDate.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    startDate.setDate(startDate.getDate() + mondayOffset);
    
    console.log(`🗓️ Prima settimana inizia lunedì: ${startDate.toISOString().slice(0,10)}`);
    
    let currentDate = new Date(startDate);
    
    // Genera tutte le settimane che toccano il mese
    while (true) {
        const weekNumber = getWeekNumber(currentDate);
        const days = [];
        
        console.log(`🔄 Processando settimana W${weekNumber} che inizia ${currentDate.toISOString().slice(0,10)}`);
        
        // Genera i 7 giorni della settimana (Dom-Lun-Mar-Mer-Gio-Ven-Sab)
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(currentDate);
            if (i === 0) {
                // Domenica: vai indietro di 1 giorno dal lunedì
                dayDate.setDate(currentDate.getDate() - 1);
            } else {
                // Lun-Sab: currentDate + (i-1)
                dayDate.setDate(currentDate.getDate() + (i - 1));
            }
            
            days.push({
                date: dayDate,
                isCurrentMonth: dayDate.getMonth() + 1 === month
            });
        }
        
        // Controlla se questa settimana tocca il mese corrente
        const weekTouchesMonth = days.some(day => day.isCurrentMonth);
        
        if (weekTouchesMonth) {
            weeks.push({
                weekNumber: weekNumber,
                days: days,
                startDate: new Date(currentDate)
            });
            console.log(`✅ Settimana W${weekNumber} aggiunta: giorni [${days.map(d => d.date.getDate()).join(', ')}]`);
        }
        
        // Vai alla settimana successiva
        currentDate.setDate(currentDate.getDate() + 7);
        
        // Stop se siamo andati troppo oltre il mese corrente
        if (currentDate.getMonth() > month - 1 && currentDate.getDate() > 7) {
            break;
        }
        
        // Sicurezza per evitare loop infinito
        if (weeks.length > 6) {
            console.warn('⚠️ Limite di 6 settimane raggiunto');
            break;
        }
    }
    
    console.log(`✅ Totale settimane generate: ${weeks.length}`);
    return weeks;
}

// Calcola il numero della settimana ISO
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// Apre l'editor per modificare il prezzo di una settimana
function openWeekEditor(weekKey, weekNumber, weekData) {
    selectedWeek = weekKey;
    const editor = document.getElementById('week-price-editor');
    const weekInfo = document.getElementById('selected-week-info');
    const priceInput = document.getElementById('week-price-input');
    const noteInput = document.getElementById('week-note-input');
    
    if (editor && weekInfo && priceInput && noteInput) {
        weekInfo.textContent = `Settimana ${weekNumber} (${weekKey})`;
        priceInput.value = weekData.price;
        noteInput.value = weekData.note || '';
        editor.classList.remove('hidden');
        
        // Evidenzia la riga selezionata
        document.querySelectorAll('.week-row').forEach(row => {
            row.classList.remove('bg-blue-100');
        });
        const selectedRow = document.querySelector(`[data-week-key="${weekKey}"]`);
        if (selectedRow) {
            selectedRow.classList.add('bg-blue-100');
        }
    }
}

// Chiude l'editor prezzi
function closeWeekEditor() {
    const editor = document.getElementById('week-price-editor');
    if (editor) {
        editor.classList.add('hidden');
    }
    
    // Rimuovi evidenziazione
    document.querySelectorAll('.week-row').forEach(row => {
        row.classList.remove('bg-blue-100');
    });
    
    selectedWeek = null;
}

// Salva il prezzo della settimana
function saveWeekPrice() {
    if (!selectedWeek) return;
    
    const priceInput = document.getElementById('week-price-input');
    const noteInput = document.getElementById('week-note-input');
    
    if (!priceInput) return;
    
    const price = parseInt(priceInput.value) || 0;
    const note = noteInput ? noteInput.value.trim() : '';
    
    // Aggiorna configurazione
    const config = CatamaranStorage.load();
    if (!config.weeklyPricing.weeks) {
        config.weeklyPricing.weeks = {};
    }
    
    config.weeklyPricing.weeks[selectedWeek] = {
        price: price,
        note: note
    };
    
    // Salva la configurazione
    const saved = CatamaranStorage.save(config);
    
    if (saved) {
        showNotification('✓ Prezzo settimana salvato!', 'success');
        // Rigenera calendario per mostrare le modifiche
        generatePricingCalendar(currentCalendarMonth, currentCalendarYear);
        closeWeekEditor();
    } else {
        showNotification('✗ Errore nel salvataggio', 'error');
    }
}

// Applica un template stagionale alle settimane selezionate
function applySeasonalTemplate(templatePrice) {
    if (!selectedWeek) {
        showNotification('Seleziona prima una settimana', 'error');
        return;
    }
    
    const priceInput = document.getElementById('week-price-input');
    if (priceInput) {
        priceInput.value = templatePrice;
    }
}

// Naviga al mese precedente
function navigateToPreviousMonth() {
    currentCalendarMonth--;
    if (currentCalendarMonth < 1) {
        currentCalendarMonth = 12;
        currentCalendarYear--;
    }
    generatePricingCalendar(currentCalendarMonth, currentCalendarYear);
    closeWeekEditor();
}

// Naviga al mese successivo
function navigateToNextMonth() {
    currentCalendarMonth++;
    if (currentCalendarMonth > 12) {
        currentCalendarMonth = 1;
        currentCalendarYear++;
    }
    generatePricingCalendar(currentCalendarMonth, currentCalendarYear);
    closeWeekEditor();
}

// Cambia anno del calendario
function changeCalendarYear(year) {
    currentCalendarYear = parseInt(year);
    generatePricingCalendar(currentCalendarMonth, currentCalendarYear);
    closeWeekEditor();
}

// Aggiorna il prezzo di default per tutte le settimane future
function updateDefaultPrice() {
    const defaultPriceInput = document.getElementById('default-weekly-price');
    if (!defaultPriceInput) return;
    
    const newDefaultPrice = parseInt(defaultPriceInput.value) || 3999;
    
    const config = CatamaranStorage.load();
    config.weeklyPricing.defaultPrice = newDefaultPrice;
    
    const saved = CatamaranStorage.save(config);
    if (saved) {
        showNotification('✓ Prezzo default aggiornato!', 'success');
        generatePricingCalendar(currentCalendarMonth, currentCalendarYear);
    }
}

// Funzioni per gestire il logo
function updateLogoPreview(logoConfig) {
    const preview = document.getElementById('logo-preview');
    console.log('🖼️ Aggiornamento anteprima logo:', logoConfig);
    
    if (!preview) {
        console.error('❌ Elemento logo-preview non trovato');
        return;
    }
    
    if (logoConfig && logoConfig.type === 'image' && logoConfig.imageUrl) {
        console.log('✅ Mostrando immagine logo');
        preview.innerHTML = `<img src="${logoConfig.imageUrl}" alt="Logo Preview" class="w-full h-full object-contain">`;
    } else {
        console.log('📝 Mostrando testo logo:', logoConfig?.text || 'Anteprima');
        preview.innerHTML = `<span class="text-sm text-gray-500">${logoConfig?.text || 'Anteprima'}</span>`;
    }
}

function handleLogoUpload(file) {
    if (!file) return;
    
    console.log('🔄 Caricamento logo:', file.name, file.size, file.type);
    
    // Verifica dimensione file (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
        showNotification('✗ Il file è troppo grande. Massimo 2MB.', 'error');
        return;
    }
    
    // Verifica tipo file
    if (!file.type.match(/^image\/(png|jpg|jpeg)$/)) {
        showNotification('✗ Formato non supportato. Usa PNG o JPG.', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        console.log('📂 File letto, caricamento configurazione...');
        const config = CatamaranStorage.load();
        
        // Assicurati che la struttura logo esista
        if (!config.theme.logo) {
            config.theme.logo = { type: 'text', imageUrl: '', text: 'logo' };
        }
        
        config.theme.logo.type = 'image';
        config.theme.logo.imageUrl = e.target.result;
        
        console.log('💾 Configurazione logo aggiornata:', config.theme.logo.type);
        
        // Aggiorna anteprima
        updateLogoPreview(config.theme.logo);
        
        // Salva automaticamente
        const saved = CatamaranStorage.save(config);
        console.log('💾 Salvataggio:', saved ? 'Successo' : 'Fallito');
        
        showNotification('✓ Logo caricato con successo!', 'success');
    };
    reader.readAsDataURL(file);
}

function resetLogo() {
    const config = CatamaranStorage.load();
    config.theme.logo.type = 'text';
    config.theme.logo.imageUrl = '';
    
    // Aggiorna anteprima
    updateLogoPreview(config.theme.logo);
    
    // Salva
    CatamaranStorage.save(config);
    showNotification('✓ Logo rimosso', 'success');
}

// Inizializzazione
window.addEventListener('load', function() {
    console.log('🚀 Admin panel caricato');
    
    try {
        // Carica configurazione
        loadConfiguration();
        
        // Collega pulsanti
        const saveButton = document.getElementById('save-button');
        const saveButtonBottom = document.getElementById('save-button-bottom');
        
        if (saveButton) {
            saveButton.addEventListener('click', saveConfiguration);
            console.log('✓ Pulsante save-button collegato');
        }
        
        if (saveButtonBottom) {
            saveButtonBottom.addEventListener('click', saveConfiguration);
            console.log('✓ Pulsante save-button-bottom collegato');
        }
        
        // Collega controlli logo
        const logoUploadInput = document.getElementById('admin-logo-upload');
        const resetLogoButton = document.getElementById('reset-logo-button');
        
        if (logoUploadInput) {
            logoUploadInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleLogoUpload(file);
                }
            });
            console.log('✓ Input logo upload collegato');
        }
        
        if (resetLogoButton) {
            resetLogoButton.addEventListener('click', resetLogo);
            console.log('✓ Pulsante reset logo collegato');
        }
        
        // Collega controlli badge
        syncColorInputs();
        
        const badgeTextInput = document.getElementById('admin-badge-text');
        const startingPriceInput = document.getElementById('admin-starting-price');
        
        if (badgeTextInput) {
            badgeTextInput.addEventListener('input', updateBadgePreview);
        }
        if (startingPriceInput) {
            startingPriceInput.addEventListener('input', updateBadgePreview);
        }
        
        // Aggiorna anteprima iniziale
        updateBadgePreview();
        
        // === INIZIALIZZAZIONE CALENDARIO PREZZI SETTIMANALI ===
        
        // Imposta il mese corrente (Maggio 2025 come da configurazione)
        const config = CatamaranStorage.load();
        if (config.calendar && config.calendar.defaultDate) {
            const defaultDate = new Date(config.calendar.defaultDate);
            currentCalendarMonth = defaultDate.getMonth() + 1;
            currentCalendarYear = defaultDate.getFullYear();
        } else {
            currentCalendarMonth = 5; // Maggio
            currentCalendarYear = 2025;
        }
        
        // Genera calendario iniziale
        generatePricingCalendar(currentCalendarMonth, currentCalendarYear);
        
        // Collega controlli navigazione calendario
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const calendarYearSelect = document.getElementById('calendar-year');
        
        if (prevMonthBtn) {
            prevMonthBtn.addEventListener('click', navigateToPreviousMonth);
            console.log('✓ Pulsante mese precedente collegato');
        }
        
        if (nextMonthBtn) {
            nextMonthBtn.addEventListener('click', navigateToNextMonth);
            console.log('✓ Pulsante mese successivo collegato');
        }
        
        if (calendarYearSelect) {
            calendarYearSelect.value = currentCalendarYear;
            calendarYearSelect.addEventListener('change', function() {
                changeCalendarYear(this.value);
            });
            console.log('✓ Selettore anno collegato');
        }
        
        // Collega editor settimana
        const closeEditorBtn = document.getElementById('close-editor');
        const saveWeekBtn = document.getElementById('save-week-price');
        
        if (closeEditorBtn) {
            closeEditorBtn.addEventListener('click', closeWeekEditor);
            console.log('✓ Pulsante chiudi editor collegato');
        }
        
        if (saveWeekBtn) {
            saveWeekBtn.addEventListener('click', saveWeekPrice);
            console.log('✓ Pulsante salva settimana collegato');
        }
        
        // Collega template stagionali
        const templateBtns = document.querySelectorAll('.template-btn');
        templateBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const price = parseInt(this.dataset.price);
                applySeasonalTemplate(price);
            });
        });
        console.log(`✓ ${templateBtns.length} template stagionali collegati`);
        
        // Collega input prezzo default
        const defaultPriceInput = document.getElementById('default-weekly-price');
        if (defaultPriceInput) {
            defaultPriceInput.addEventListener('change', updateDefaultPrice);
            console.log('✓ Input prezzo default collegato');
        }
        
        console.log('📅 Calendario prezzi settimanali inizializzato');
        console.log('✅ Inizializzazione completata');
        
    } catch (error) {
        console.error('❌ Errore inizializzazione:', error);
    }
});
</script>

</body>
</html>