<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Test Debug - Servizi Admin ‚Üí Prenotazione</title>
    <script src="catamaran-config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .debug-container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .debug-section { margin-bottom: 30px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; }
        .debug-success { background-color: #e8f5e8; border-color: #4caf50; }
        .debug-error { background-color: #ffeaea; border-color: #f44336; }
        .debug-warning { background-color: #fff8e1; border-color: #ff9800; }
        .debug-info { background-color: #e3f2fd; border-color: #2196f3; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 4px; font-size: 12px; overflow-x: auto; max-height: 300px; }
        .status { font-weight: bold; margin: 10px 0; }
        button { background: #2196F3; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #1976D2; }
        button.success { background: #4caf50; }
        button.error { background: #f44336; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #2196f3; background: #f9f9f9; }
        .service-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 4px 0; background: #f5f5f5; border-radius: 4px; }
        .service-price { font-weight: bold; color: #4caf50; }
        .service-status { padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .service-ok { background: #e8f5e8; color: #4caf50; }
        .service-error { background: #ffeaea; color: #f44336; }
    </style>
</head>
<body>

<div class="debug-container">
    <h1>üîß Debug: Sincronizzazione Servizi Admin ‚Üí Prenotazione</h1>
    
    <div class="debug-section debug-info">
        <h2>üìã Obiettivo del Test</h2>
        <p>Verificare che le modifiche nell'admin panel vengano correttamente salvate nella configurazione e poi caricate nella pagina prenotazione.</p>
        <div class="step">
            <strong>1.</strong> Verifica struttura HTML admin panel
        </div>
        <div class="step">
            <strong>2.</strong> Simula modifica servizi nell'admin
        </div>
        <div class="step">
            <strong>3.</strong> Verifica salvataggio configurazione
        </div>
        <div class="step">
            <strong>4.</strong> Simula caricamento in pagina prenotazione
        </div>
    </div>

    <div class="debug-section" id="step1">
        <h2>üîç Step 1: Verifica Struttura Admin Panel</h2>
        <button onclick="debugAdminStructure()">Analizza Struttura Admin</button>
        <div id="step1-results" class="status"></div>
        <pre id="step1-details"></pre>
    </div>

    <div class="debug-section" id="step2">
        <h2>‚öôÔ∏è Step 2: Simula Salvataggio da Admin</h2>
        <button onclick="simulateAdminSave()">Simula Modifiche Admin</button>
        <div id="step2-results" class="status"></div>
        <pre id="step2-details"></pre>
    </div>

    <div class="debug-section" id="step3">
        <h2>üíæ Step 3: Verifica Configurazione Salvata</h2>
        <button onclick="verifyConfigurationSaved()">Verifica Config</button>
        <div id="step3-results" class="status"></div>
        <div id="step3-services"></div>
    </div>

    <div class="debug-section" id="step4">
        <h2>üìÑ Step 4: Simula Caricamento Prenotazione</h2>
        <button onclick="simulateBookingPageLoad()">Simula Prenotazione</button>
        <div id="step4-results" class="status"></div>
        <pre id="step4-details"></pre>
    </div>

    <div class="debug-section" id="summary">
        <h2>üìä Riepilogo Debug</h2>
        <div id="debug-summary"></div>
    </div>
</div>

<script>
let debugResults = {};

function debugAdminStructure() {
    try {
        console.log('üîç Analizzando struttura admin panel...');
        
        // Simula la struttura dell'admin panel
        const adminStructure = {
            skipperElements: {
                price: !!document.getElementById('skipper-price'),
                name: !!document.getElementById('skipper-name'),
                description: !!document.getElementById('skipper-description'),
                unit: !!document.getElementById('skipper-unit'),
                icon: !!document.getElementById('skipper-icon-input')
            },
            serviceEditors: [],
            serviceClassElements: {
                names: document.querySelectorAll('.service-name').length,
                prices: document.querySelectorAll('.service-price').length,
                units: document.querySelectorAll('.service-unit').length,
                descriptions: document.querySelectorAll('.service-description').length,
                icons: document.querySelectorAll('.service-icon-input').length,
                enabled: document.querySelectorAll('.service-enabled').length
            }
        };
        
        // Simula la ricerca dei service editors (dato che non sono nella pagina di test)
        const expectedServices = ['wifi', 'watersports', 'pizza', 'bimby', 'kitchen', 'fishing'];
        expectedServices.forEach(service => {
            adminStructure.serviceEditors.push({
                service: service,
                found: false, // In questa pagina di test non ci sono
                elements: {
                    name: false,
                    price: false,
                    unit: false,
                    description: false,
                    icon: false,
                    enabled: false
                }
            });
        });
        
        const skipperElementsCount = Object.values(adminStructure.skipperElements).filter(Boolean).length;
        const skipperComplete = skipperElementsCount === 5;
        const classElementsTotal = Object.values(adminStructure.serviceClassElements).reduce((a, b) => a + b, 0);
        
        const success = skipperComplete || classElementsTotal > 0;
        debugResults.structure = success;
        
        if (success) {
            document.getElementById('step1-results').innerHTML = '‚úÖ Struttura admin analizzata';
            document.getElementById('step1').className = 'debug-section debug-success';
        } else {
            document.getElementById('step1-results').innerHTML = '‚ùå Struttura admin incompleta';
            document.getElementById('step1').className = 'debug-section debug-error';
        }
        
        document.getElementById('step1-details').textContent = JSON.stringify(adminStructure, null, 2);
        
        console.log('Struttura admin:', adminStructure);
        updateSummary();
        
    } catch (error) {
        debugResults.structure = false;
        document.getElementById('step1-results').innerHTML = '‚ùå Errore: ' + error.message;
        document.getElementById('step1').className = 'debug-section debug-error';
        console.error('Errore analisi struttura:', error);
    }
}

function simulateAdminSave() {
    try {
        console.log('‚öôÔ∏è Simulando salvataggio da admin panel...');
        
        // Carica configurazione attuale
        const config = CatamaranStorage.load();
        
        // Simula modifiche tipiche che un utente potrebbe fare
        const modifications = {
            // Simula modifica skipper
            skipper: {
                name: 'Capitano Professionale MODIFICATO',
                price: 250, // Cambiato da 200 a 250
                unit: 'giorno',
                description: 'Descrizione skipper modificata in test debug',
                icon: 'ri-steering-2-line'
            },
            // Simula modifica wifi
            wifi: {
                name: 'Internet Wi-Fi MODIFICATO', 
                price: 75, // Cambiato da 50 a 75
                unit: 'tantum',
                description: 'Connessione internet modificata in test debug',
                icon: 'ri-wifi-line'
            },
            // Simula modifica pizza
            pizza: {
                name: 'Kit Pizza Gourmet MODIFICATO',
                price: 199, // Cambiato da 150 a 199
                unit: 'tantum', 
                description: 'Kit pizza modificato in test debug',
                icon: 'ri-restaurant-2-line'
            }
        };
        
        // Applica le modifiche
        if (!config.additionalServices) {
            config.additionalServices = {};
        }
        
        Object.entries(modifications).forEach(([serviceKey, serviceData]) => {
            config.additionalServices[serviceKey] = {
                ...config.additionalServices[serviceKey],
                ...serviceData,
                recommended: serviceKey === 'skipper',
                enabled: true
            };
            console.log(`Modificato servizio ${serviceKey}:`, serviceData);
        });
        
        // Salva la configurazione
        const saveResult = CatamaranStorage.save(config);
        
        debugResults.adminSave = saveResult;
        
        if (saveResult) {
            document.getElementById('step2-results').innerHTML = '‚úÖ Simulazione salvataggio completata';
            document.getElementById('step2').className = 'debug-section debug-success';
        } else {
            document.getElementById('step2-results').innerHTML = '‚ùå Errore nel salvataggio';
            document.getElementById('step2').className = 'debug-section debug-error';
        }
        
        document.getElementById('step2-details').textContent = JSON.stringify({
            modifications,
            saveResult,
            configKeys: Object.keys(config.additionalServices)
        }, null, 2);
        
        updateSummary();
        
    } catch (error) {
        debugResults.adminSave = false;
        document.getElementById('step2-results').innerHTML = '‚ùå Errore: ' + error.message;
        document.getElementById('step2').className = 'debug-section debug-error';
        console.error('Errore simulazione admin save:', error);
    }
}

function verifyConfigurationSaved() {
    try {
        console.log('üíæ Verificando configurazione salvata...');
        
        const config = CatamaranStorage.load();
        const services = config.additionalServices || {};
        
        const verificationResults = {
            configExists: !!config,
            servicesExist: !!config.additionalServices,
            serviceCount: Object.keys(services).length,
            servicesDetails: {}
        };
        
        // Verifica ogni servizio
        Object.entries(services).forEach(([key, service]) => {
            verificationResults.servicesDetails[key] = {
                hasName: !!service.name,
                hasPrice: service.price !== undefined,
                hasUnit: !!service.unit,
                hasDescription: !!service.description,
                hasIcon: !!service.icon,
                priceValue: service.price,
                nameValue: service.name
            };
        });
        
        const servicesContainer = document.getElementById('step3-services');
        servicesContainer.innerHTML = '';
        
        Object.entries(services).forEach(([key, service]) => {
            const isComplete = service.name && service.price !== undefined && service.icon;
            const serviceElement = document.createElement('div');
            serviceElement.className = 'service-item';
            serviceElement.innerHTML = `
                <span><strong>${key}:</strong> ${service.name || 'N/A'}</span>
                <span class="service-price">‚Ç¨${service.price || 0}</span>
                <span class="service-status ${isComplete ? 'service-ok' : 'service-error'}">
                    ${isComplete ? 'OK' : 'INCOMPLETO'}
                </span>
            `;
            servicesContainer.appendChild(serviceElement);
        });
        
        const success = verificationResults.serviceCount >= 3; // Almeno 3 servizi
        debugResults.configVerify = success;
        
        if (success) {
            document.getElementById('step3-results').innerHTML = `‚úÖ ${verificationResults.serviceCount} servizi in configurazione`;
            document.getElementById('step3').className = 'debug-section debug-success';
        } else {
            document.getElementById('step3-results').innerHTML = `‚ö†Ô∏è Solo ${verificationResults.serviceCount} servizi trovati`;
            document.getElementById('step3').className = 'debug-section debug-warning';
        }
        
        updateSummary();
        
    } catch (error) {
        debugResults.configVerify = false;
        document.getElementById('step3-results').innerHTML = '‚ùå Errore: ' + error.message;
        document.getElementById('step3').className = 'debug-section debug-error';
        console.error('Errore verifica configurazione:', error);
    }
}

function simulateBookingPageLoad() {
    try {
        console.log('üìÑ Simulando caricamento pagina prenotazione...');
        
        const config = CatamaranStorage.load();
        
        // Simula il processo renderAdditionalServices() dalla pagina prenotazione
        const services = Object.entries(config.additionalServices || {})
            .filter(([key, service]) => key !== 'skipper'); // Escludi skipper che √® gestito separatamente
        
        const renderResults = {
            configLoaded: !!config,
            servicesFound: services.length,
            renderedServices: []
        };
        
        // Simula il rendering di ogni servizio
        services.forEach(([serviceKey, service]) => {
            if (!service.name || service.price === undefined) {
                renderResults.renderedServices.push({
                    key: serviceKey,
                    status: 'ERRORE',
                    reason: 'Dati incompleti',
                    data: { name: service.name, price: service.price }
                });
                return;
            }
            
            const unitText = service.unit === 'giorno' ? '/giorno' : 
                           service.unit === 'settimana' ? '/settimana' : 
                           '(una tantum)';
            
            // Simula la creazione dell'HTML del servizio
            const serviceHTML = {
                name: service.name,
                price: `‚Ç¨${service.price} ${unitText}`,
                description: service.description || '',
                icon: service.icon || 'ri-service-line',
                recommended: service.recommended || false
            };
            
            renderResults.renderedServices.push({
                key: serviceKey,
                status: 'OK',
                html: serviceHTML
            });
        });
        
        // Simula anche lo skipper
        if (config.additionalServices?.skipper) {
            const skipper = config.additionalServices.skipper;
            const skipperResult = {
                key: 'skipper',
                status: 'OK',
                html: {
                    name: skipper.name,
                    price: `‚Ç¨${skipper.price}/${skipper.unit}`,
                    description: skipper.description
                }
            };
            renderResults.renderedServices.unshift(skipperResult);
        }
        
        const successfulRenders = renderResults.renderedServices.filter(s => s.status === 'OK').length;
        const success = successfulRenders >= 3;
        
        debugResults.bookingLoad = success;
        
        if (success) {
            document.getElementById('step4-results').innerHTML = `‚úÖ ${successfulRenders} servizi renderizzati correttamente`;
            document.getElementById('step4').className = 'debug-section debug-success';
        } else {
            document.getElementById('step4-results').innerHTML = `‚ö†Ô∏è Solo ${successfulRenders} servizi renderizzati`;
            document.getElementById('step4').className = 'debug-section debug-warning';
        }
        
        document.getElementById('step4-details').textContent = JSON.stringify(renderResults, null, 2);
        
        updateSummary();
        
    } catch (error) {
        debugResults.bookingLoad = false;
        document.getElementById('step4-results').innerHTML = '‚ùå Errore: ' + error.message;
        document.getElementById('step4').className = 'debug-section debug-error';
        console.error('Errore simulazione booking load:', error);
    }
}

function updateSummary() {
    const results = Object.values(debugResults);
    const passed = results.filter(Boolean).length;
    const total = results.length;
    
    if (total === 0) return;
    
    const percentage = Math.round((passed / total) * 100);
    let summaryClass = 'debug-success';
    if (percentage < 80) summaryClass = 'debug-warning';
    if (percentage < 60) summaryClass = 'debug-error';
    
    const status = percentage >= 80 ? '‚úÖ INTEGRAZIONE FUNZIONANTE' : 
                  percentage >= 60 ? '‚ö†Ô∏è PROBLEMI PARZIALI' : 
                  '‚ùå PROBLEMI CRITICI';
    
    document.getElementById('debug-summary').innerHTML = `
        <div class="${summaryClass}" style="padding: 15px; border-radius: 5px;">
            <h3>üîß Risultati Debug</h3>
            <p><strong>Test superati: ${passed}/${total} (${percentage}%)</strong></p>
            <p><strong>Status: ${status}</strong></p>
            <div style="margin-top: 15px;">
                <strong>Dettagli Step:</strong><br>
                1. Struttura Admin: ${debugResults.structure ? '‚úÖ' : '‚ùå'}<br>
                2. Salvataggio Admin: ${debugResults.adminSave ? '‚úÖ' : '‚ùå'}<br>
                3. Configurazione Salvata: ${debugResults.configVerify ? '‚úÖ' : '‚ùå'}<br>
                4. Caricamento Prenotazione: ${debugResults.bookingLoad ? '‚úÖ' : '‚ùå'}
            </div>
            ${percentage < 100 ? '<p style="margin-top: 10px; color: #ff9800;"><strong>Raccomandazione:</strong> Verificare i passaggi falliti e controllare la console del browser per errori JavaScript.</p>' : ''}
        </div>
    `;
}

// Auto-start debug quando la pagina √® caricata
window.addEventListener('load', function() {
    setTimeout(() => {
        console.log('üöÄ Avvio debug automatico...');
        debugAdminStructure();
        setTimeout(() => simulateAdminSave(), 500);
        setTimeout(() => verifyConfigurationSaved(), 1000);
        setTimeout(() => simulateBookingPageLoad(), 1500);
    }, 1000);
});
</script>

</body>
</html>